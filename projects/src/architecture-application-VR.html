<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture VR</title>
    <link rel="stylesheet" href="../../css/w3.css">

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>

    <!-- Library of Virtual Reality -->
    <script type="text/javascript" charset="UTF-8" src="../libs/aframe-master.js"></script>
    <script type="text/javascript" charset="UTF-8" src="../libs/util/Aframe-Extras/aframe-extras.js"></script>
    <!-- Details about aframe-extras "controls" here:
        https://github.com/donmccurdy/aframe-extras/tree/master/src/controls
    -->

    <script>
        const floor = [];

        AFRAME.registerComponent('modify-materials', {
            init: function () {
                // Wait for model to load.
                this.el.addEventListener('model-loaded', () => {
                    // Grab the mesh
                    const obj = this.el.getObject3D('mesh');

                    obj.scale.set(1.3, 1.3, 1.3);

                    obj.children.forEach(element => {
                        if (/window/i.test(element.name)) {
                            element.children[0].material.transparency = true;
                            element.children[0].material.opacity = 0.7;
                            floor.push(element.children[1])
                        } else if (/water/i.test(element.name)) {
                            element.material.transparency = true;
                            element.material.opacity = 0.7;
                        } else if (/ground|stairs|floor/i.test(element.name)) {
                            floor.push(element);
                        }
                        else if (/balcony|patio/i.test(element.name)) {
                            floor.push(element.children[1]);
                        }
                    });
                });
            }
        });

        AFRAME.registerComponent('teleport', {
            init: function () {
                this.gamepad = null;
                this.obj = this.el.object3D;
                this.objPos = new THREE.Vector3();
                this.camera = document.querySelector('#camera');
                this.canTeleport = true;
                this.raycaster = new THREE.Raycaster();
                this.direction = new THREE.Vector3();
                this.intersection;

                let self = this
                window.addEventListener("gamepadconnected", function (e) {
                    console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                        e.gamepad.index, e.gamepad.id,
                        e.gamepad.buttons.length, e.gamepad.axes.length);

                    self.canTeleport = true;
                });

                window.addEventListener("keydown", (e) => {
                    if (e.keyCode == 32) this.teleport();
                });

                window.addEventListener('touchstart', (e) => {
                    this.teleport();
                })

                let material = new THREE.MeshBasicMaterial({
                    color: 0x7744AA,
                    side: THREE.DoubleSide,
                });

                this.teleportMark = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.5, 0.5, 0.2, 20, 1, true),
                    material
                );

                this.teleportMark.position.set(-3, 0, 15);
                this.obj.position.set(-3, 0, 18);

                this.el.parentEl.setObject3D('telep', this.teleportMark);

                this.objPos.copy(this.obj.position);
                this.objPos.y += 1.4;

                let tubeGeometry = new THREE.TubeBufferGeometry(new THREE.LineCurve3(this.objPos, this.teleportMark.position), 1, 0.01, 5, false);
                this.tube = new THREE.Mesh(tubeGeometry, material);

                this.el.sceneEl.setObject3D('tube', this.tube)
            },
            tick: function (time, delta) {
                this.gamepad = navigator.getGamepads()[0];

                camera.object3D.getWorldDirection(this.direction);
                this.direction.multiplyScalar(-1);
                if (this.direction.y > -0.2) {
                    this.direction.y = -0.2;
                }

                this.objPos.copy(this.obj.position);
                this.objPos.y += 1.4;

                this.raycaster.far = 9
                this.raycaster.set(this.objPos, this.direction);
                this.intersection = this.raycaster.intersectObjects(floor);

                if (this.intersection[0] && this.intersection[0].face.normal.x == 0 && this.intersection[0].face.normal.z == 0) {
                    this.teleportMark.position.copy(this.intersection[0].point);
                    this.teleportMark.position.y += 0.15;
                }

                this.tube.geometry = new THREE.TubeBufferGeometry(new THREE.LineCurve3(this.objPos, this.teleportMark.position), 1, 0.01, 5, false);
                this.tube.geometry.needsupdate = true;

                if (!this.gamepad) return;

                if (this.gamepad.buttons.some(btn => btn.pressed)) {
                    this.teleport();
                }

            },
            teleport: function () {
                if (this.canTeleport) {
                    this.obj.position.x = this.teleportMark.position.x;
                    this.obj.position.y = this.teleportMark.position.y;
                    this.obj.position.z = this.teleportMark.position.z;
                    this.canTeleport = false;
                    setTimeout(() => { this.canTeleport = true }, 500);
                    console.log('teleported')
                }
            }
        });
    </script>
</head>

<body>
    <a-scene main_scene id="scene" time light="defaultLightsEnabled: false" renderer="antialias: true; alpha: true">
        <a-assets timeout="60000">
            <a-asset-item id="house" src="./assets/models/modern-house.glb"></a-asset-item>
            <img id="skyBoxMap" src="./assets/textures/cloud.jpg">
        </a-assets>

        <a-entity id="rig" position="-3 0 18" teleport>
            <a-entity id="camera" camera position="0 1.5 0" look-controls="pointerLockEnabled: true">
            </a-entity>
        </a-entity>

        <a-entity light="type: ambient; color: #fff; intensity: 0.3"></a-entity>
        <a-entity light="color: #fff" position="65 110 52"></a-entity>

        <a-sky id="skyBox" material="src: #skyBoxMap"></a-sky>

        <a-entity id="house" gltf-model="#house" modify-materials></a-entity>

    </a-scene>>

</body>

</html>